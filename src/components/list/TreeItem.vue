<script setup lang="ts">
import { computed, defineAsyncComponent, watch } from 'vue';
import { generateUUID } from '@/utils/stringUtils';
import LxButton from '@/components/Button.vue';
import LxListItem from '@/components/list/ListItem.vue';
import useLx from '@/hooks/useLx';
import LxRadioButton from '@/components/RadioButton.vue';
import LxCheckbox from '@/components/Checkbox.vue';
import LxIcon from '@/components/Icon.vue';
// eslint-disable-next-line import/no-self-import
const LxTreeItem = defineAsyncComponent(() => import('@/components/list/TreeItem.vue'));

const props = defineProps({
  id: { type: String, default: () => generateUUID() },
  items: { type: Array, default: null },
  idAttribute: { type: String, default: 'id' },
  primaryAttribute: { type: String, default: 'name' },
  secondaryAttribute: { type: String, default: 'description' },
  childrenAttribute: { type: String, default: 'children' },
  hasChildrenAttribute: { type: String, default: 'hasChildren' },
  hrefAttribute: { type: String, default: 'href' },
  clickableAttribute: { type: String, default: 'clickable' },
  iconAttribute: { type: String, default: 'icon' },
  iconSetAttribute: { type: String, default: 'iconSet' },
  tooltipAttribute: { type: String, default: 'tooltip' },
  categoryAttribute: { type: String, default: 'category' },
  selectableAttribute: { type: String, default: 'selectable' },
  hasSearch: { type: Boolean, default: false },
  areSomeExpandable: { type: Boolean, default: null },
  query: { type: String, default: '' },
  actionDefinitions: { type: Array, default: null },
  actionsLayout: { type: String, default: 'default' }, // default, vertical
  icon: { type: String, default: 'open' },
  iconSet: {
    type: String,
    default: () => useLx().getGlobals()?.iconSet,
  },
  hasSelecting: { type: Boolean, default: false },
  selectingKind: { type: String, default: 'single' }, // single, multiple
  selectedItems: { type: Object, default: () => {} },
  itemsStates: { type: Object, default: () => {} },
  mode: { type: String, default: 'client' }, // client, server
  texts: { type: Object, default: () => {} },
  parents: { type: Array, default: () => [] },
  children: { type: Object, default: () => {} },
  disabled: { type: Boolean, default: false },
});

const emits = defineEmits([
  'actionClick',
  'update:selectedItems',
  'update:itemsStates',
  'loadChildren',
  'update:selectedChildren',
]);

function actionClicked(actionName, rowCode) {
  emits('actionClick', actionName, rowCode);
}

const selected = computed({
  get() {
    return props.selectedItems;
  },
  set(value) {
    emits('update:selectedItems', value);
  },
});

const states = computed({
  get() {
    return props.itemsStates;
  },
  set(value) {
    emits('update:itemsStates', value);
  },
});

function selectRow(id) {
  selected.value = { [id]: true };
}

function isExpanded(id) {
  return states.value?.[id]?.expanded;
}

function collapse(id, element) {
  states.value[id] = {
    ...states.value?.[id],
    expanded: !states.value?.[id]?.expanded,
  };
  if (
    props.mode === 'server' &&
    (!element?.[props.childrenAttribute] || element?.[props.childrenAttribute]?.length === 0) &&
    states.value?.[id]?.expanded
  ) {
    emits('loadChildren', id);
    states.value[id] = {
      ...states.value?.[id],
      busy: true,
    };
  }
}

function isExpandable(item) {
  if (props.mode === 'client')
    return item[props.childrenAttribute] && item?.[props.childrenAttribute].length > 0;
  return item[props.hasChildrenAttribute];
}

function hasChildren(item) {
  if (props.mode === 'client')
    return item[props.childrenAttribute] && isExpanded(item[props.idAttribute]);
  return item[props.hasChildrenAttribute] && isExpanded(item[props.idAttribute]);
}

function reloadItem(id) {
  emits('loadChildren', id);
  states.value[id] = {
    ...states.value?.[id],
    busy: true,
  };
}

function loadChildren(id) {
  emits('loadChildren', id);
}

function updateParents(item) {
  const p = [...props.parents];
  p.push(item?.[props.idAttribute]);
  return p;
}

function hasSelectedChildren(id) {
  let res = false;
  Object.keys(selected.value).forEach((key) => {
    if (selected.value[key] && props.children?.[id].includes(key)) res = true;
    return true;
  });
  return res;
}
const areSomeExpandable = computed(() => props.items.some((item) => isExpandable(item)));

const isSelectable = (item) => {
  const attribute = props.selectableAttribute;
  if (item[attribute] === false) return false;
  return item[attribute] !== false;
};

const isItemSelected = computed(() => (itemId) => !!selected.value[itemId]);

watch(
  () => props.mode,
  (newMode) => {
    if (newMode === 'client') {
      Object.keys(states.value).forEach((id) => {
        states.value[id] = {
          ...states.value[id],
          busy: false,
        };
      });
    }
  }
);
</script>
<template>
  <div class="tree-item" v-for="item in items" :key="item[idAttribute]" role="listitem">
    <div
      class="tree-item-body"
      :class="[
        {
          'not-expandable':
            !isExpandable(item) &&
            (parents.length === 0 ? props.areSomeExpandable || areSomeExpandable : true),
        },
        { 'selected-children': hasSelectedChildren(item[idAttribute]) },
      ]"
    >
      <LxButton
        v-if="isExpandable(item)"
        kind="ghost"
        :icon="isExpanded(item?.[idAttribute]) ? 'chevron-up' : 'chevron-down'"
        variant="icon-only"
        :label="isExpanded(item?.[idAttribute]) ? texts?.collapse : texts?.expand"
        :disabled="disabled || states?.[item[idAttribute]]?.disabled"
        @click="collapse(item?.[idAttribute], item)"
      />
      <div class="lx-list-item-container">
        <LxListItem
          :id="item[idAttribute]"
          :label="item[primaryAttribute]"
          :description="item[secondaryAttribute]"
          :href="item[hrefAttribute]"
          :clickable="item[clickableAttribute]"
          :actionDefinitions="actionDefinitions"
          :actionsLayout="actionsLayout"
          :icon="item[iconAttribute] ? item[iconAttribute] : icon"
          :iconSet="item[iconSetAttribute] ? item[iconSetAttribute] : iconSet"
          :tooltip="item[tooltipAttribute]"
          :category="item[categoryAttribute]"
          :disabled="disabled || states?.[item[idAttribute]]?.disabled"
          :busy="states?.[item[idAttribute]]?.busy"
          :value="item"
          :selected="isItemSelected(item[idAttribute])"
          :searchString="query"
          @action-click="actionClicked"
          @click="item[hrefAttribute] ? null : actionClicked('click', item[idAttribute])"
        >
          <template #customItem="item" v-if="$slots.customItem">
            <slot name="customItem" v-bind="item" />
          </template>
        </LxListItem>
        <div class="selecting-block" v-if="hasSelecting">
          <template v-if="isSelectable(item)">
            <LxRadioButton
              v-if="selectingKind === 'single'"
              :id="`select-${id}-${item[idAttribute]}`"
              v-model="selected[item[idAttribute]]"
              :value="item[idAttribute]"
              :disabled="
                disabled ||
                states?.[item[idAttribute]]?.disabled ||
                states?.[item[idAttribute]]?.busy
              "
              @click="selectRow(item[idAttribute])"
            />
            <LxCheckbox
              v-else
              :id="`select-${id}-${item[idAttribute]}`"
              v-model="selected[item[idAttribute]]"
              :value="item[idAttribute]"
              :disabled="
                disabled ||
                states?.[item[idAttribute]]?.disabled ||
                states?.[item[idAttribute]]?.busy
              "
            />
          </template>
          <p v-else class="lx-checkbox-placeholder"></p>
        </div>
      </div>
    </div>
    <div class="tree-item-invalid" v-if="states?.[item[idAttribute]]?.invalid">
      <div class="invalid-text">
        <LxIcon value="invalid" />
        {{ texts?.loadingError }}
      </div>
      <LxButton
        kind="ghost"
        icon="refresh"
        variant="icon-only"
        :label="texts?.reload"
        :disabled="disabled"
        @click="reloadItem(item[idAttribute])"
      />
    </div>
    <LxTreeItem
      v-if="hasChildren(item)"
      :items="item[childrenAttribute]"
      :idAttribute="idAttribute"
      :primaryAttribute="primaryAttribute"
      :secondaryAttribute="secondaryAttribute"
      :childrenAttribute="childrenAttribute"
      :hasChildrenAttribute="hasChildrenAttribute"
      :hrefAttribute="hrefAttribute"
      :clickableAttribute="clickableAttribute"
      :iconAttribute="iconAttribute"
      :iconSetAttribute="iconSetAttribute"
      :tooltipAttribute="tooltipAttribute"
      :categoryAttribute="categoryAttribute"
      :selectable-attribute="selectableAttribute"
      :action-definitions="actionDefinitions"
      :actionsLayout="actionsLayout"
      :icon="icon"
      :iconSet="iconSet"
      :hasSelecting="hasSelecting"
      :selectingKind="selectingKind"
      v-model:selected-items="selected"
      v-model:items-states="states"
      :mode="mode"
      :texts="texts"
      :parents="updateParents(item)"
      :children="children"
      :disabled="disabled"
      @loadChildren="loadChildren"
      @action-click="actionClicked"
    >
      <template #customItem="customItem" v-if="$slots.customItem">
        <slot name="customItem" v-bind="customItem" />
      </template>
    </LxTreeItem>
  </div>
</template>
